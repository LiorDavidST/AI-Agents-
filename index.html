<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <title>AI LAW SERVICES</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
</head>
<body>
    <!-- Feedback Message -->
    <div id="feedback" class="hidden"></div>

    <!-- Chat Containers -->
    <div id="chats-container" class="chatbox-center">
        <div id="cohere-chat" class="chat-container">
            <header class="chat-header">
                <h2>AI LAW SERVICES</h2>
            </header>
            <div class="chat-content">
                <!-- Left Section: Chat Display -->
                <div class="chat-left">
                    <h4>Select a Law:</h4>
                    <div id="law-selection" class="law-selection-container">
                        <!-- Dynamically loaded buttons for laws -->
                    </div>
                    <input type="file" id="file-input" accept=".txt,.doc,.docx,.pdf">
                    <button id="check-compliance-btn" aria-label="Check Compliance">Check Compliance</button>
                </div>
                <!-- Right Section: Results -->
                <div class="chat-right">
                    <h2>Compliance Results</h2>
                    <div id="compliance-results" class="hidden">
                        <table>
                            <thead>
                                <tr>
                                    <th>Section</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                                <!-- Results dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const lawSelectionContainer = document.getElementById("law-selection");
            const fileInput = document.getElementById("file-input");
            const checkComplianceBtn = document.getElementById("check-compliance-btn");
            const complianceResultsContainer = document.getElementById("compliance-results");
            const resultsTableBody = document.getElementById("results-table-body");

            // Fetch laws and populate selection
            const fetchLaws = async () => {
                try {
                    const response = await fetch("/api/predefined-laws");
                    const data = await response.json();
                    const laws = data.laws || {};

                    lawSelectionContainer.innerHTML = ""; // Clear existing content

                    if (Object.keys(laws).length === 0) {
                        lawSelectionContainer.innerHTML = "<p>No laws available.</p>";
                        return;
                    }

                    Object.entries(laws).forEach(([id, title]) => {
                        const button = document.createElement("button");
                        button.textContent = title;
                        button.className = "law-button";
                        button.dataset.lawId = id;

                        lawSelectionContainer.appendChild(button);
                    });
                } catch (error) {
                    console.error("Error fetching laws:", error);
                    lawSelectionContainer.innerHTML = "<p>Error loading laws. Please try again later.</p>";
                }
            };

            // Handle law selection and file upload
            const checkCompliance = async () => {
                const selectedLawButton = document.querySelector(".law-button.selected");
                const file = fileInput.files[0];

                if (!selectedLawButton || !file) {
                    alert("Please select a law and upload a file.");
                    return;
                }

                const lawId = selectedLawButton.dataset.lawId;

                const formData = new FormData();
                formData.append("file", file);
                formData.append("law_id", lawId);

                try {
                    const response = await fetch("/api/contract-compliance", {
                        method: "POST",
                        body: formData,
                    });
                    const results = await response.json();

                    if (response.ok) {
                        displayResults(results);
                    } else {
                        console.error("Error:", results.error);
                    }
                } catch (error) {
                    console.error("Error during compliance check:", error);
                }
            };

            // Display results in the table
            const displayResults = (results) => {
                resultsTableBody.innerHTML = ""; // Clear existing rows

                results.forEach((result) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${result.section}</td>
                        <td>${result.status}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });

                complianceResultsContainer.classList.remove("hidden");
            };

            // Add event listener to law buttons
            lawSelectionContainer.addEventListener("click", (e) => {
                if (e.target.classList.contains("law-button")) {
                    document
                        .querySelectorAll(".law-button")
                        .forEach((button) => button.classList.remove("selected"));
                    e.target.classList.add("selected");
                }
            });

            // Add event listener to compliance button
            checkComplianceBtn.addEventListener("click", checkCompliance);

            // Fetch laws on page load
            fetchLaws();
        });
    </script>
</body>
</html>
